<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>URL Shortener</title>
</head>
<body>
  <div>
    <input type="text" id="urlInput" placeholder="Paste long URL" />
    <input type="text" id="customInput" placeholder="Custom alias (optional)" />
    <button onclick="shortenUrl()">Shorten</button>
    <div id="result"></div>
  </div>

  <script>
    const storageKey = "shortened_links";

    function saveToLocalStorage(link, clicks = 0) {
      const links = JSON.parse(localStorage.getItem(storageKey)) || [];
      links.push({ link, clicks });
      localStorage.setItem(storageKey, JSON.stringify(links));
      displayLinks();
    }

    function displayLinks() {
      const result = document.getElementById('result');
      const links = JSON.parse(localStorage.getItem(storageKey)) || [];
      result.innerHTML = links.map(item =>
        `<div>
          <a href="${item.link}" onclick="incrementClick('${item.link}')" target="_blank">${item.link}</a>
          - Clicks: <span id="${item.link}">${item.clicks}</span>
        </div>`
      ).join("");
    }

    function incrementClick(link) {
      const links = JSON.parse(localStorage.getItem(storageKey)) || [];
      const updated = links.map(item => {
        if (item.link === link) {
          item.clicks += 1;
          document.getElementById(link).innerText = item.clicks;
        }
        return item;
      });
      localStorage.setItem(storageKey, JSON.stringify(updated));
    }

    async function shortenUrl() {
      const url = document.getElementById('urlInput').value;
      const custom = document.getElementById('customInput').value;

      const res = await fetch('/api/shorten', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url, custom }),
      });

      const data = await res.json();
      if (data.shortened_url) {
        saveToLocalStorage(data.shortened_url, 0);
      } else {
        alert(data.error || "Something went wrong.");
      }
    }

    displayLinks();
  </script>
</body>
</html>
